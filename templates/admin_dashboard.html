<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Admin Dashboard</title>
        <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: Arial, sans-serif;
        }

        body {
            display: flex;
            background-color: #f4f5f7;
        }

        /* Sidebar */
        .sidebar {
            width: 250px;
            height: 100vh;
            background-color: #3a3f51;
            color: #fff;
            position: fixed;
            top: 0;
            left: 0;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h2 {
            margin-bottom: 20px;
        }

        .sidebar ul {
            list-style-type: none;
        }

        .sidebar ul li {
            padding: 15px;
            margin: 10px 0;
            cursor: pointer;
            background-color: #3f4558;
            border-radius: 5px;
        }

        .sidebar ul li:hover {
            background-color: #50597b;
        }

        /* Main Content */
        .main-content {
            margin-left: 270px;
            padding: 20px;
            width: calc(100% - 270px);
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background-color: #fff;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .header input {
            padding: 8px;
            width: 300px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }

        button {
            padding: 10px;
            background-color: #3a3f51;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background-color: #50597b;
        }

        .feature-section {
            display: none;  /* Hide sections initially */
        }

        button#logoutButton {
            padding: 10px 15px;
            background-color: #d9534f; /* A red color for logout button */
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 20px;
        }

        button#logoutButton:hover {
            background-color: #c9302c;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 10px;
            border: 1px solid #ccc;
            text-align: left;
        }

        th {
            background-color: #3a3f51;
            color: white;
        }
    </style>
    </head>
    <body>
        <!-- Sidebar -->
        <div class="sidebar">
            <h2>Dashboard</h2>
            <ul>
                <li onclick="showSection('uploadDataset')">Upload Dataset</li>
                <li onclick="showSection('dataVisualization')">Data
                    Visualization</li>
                <li onclick="showSection('dataPrediction')">Data Prediction</li>
                <li onclick="showSection('manageUsersTable')">Manage Users</li>

                <li onclick="showSection('qnaSection')">Q&A Section</li>
                <li onclick="logout()"
                    style="background-color: #d9534f;">Logout</li>
                <!-- Logout Button -->
            </ul>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="header">
                <h2>Welcome to Admin Dashboard</h2>
            </div>
            <p>Select a feature from the sidebar to begin.</p>

            <!-- Upload Dataset Section -->
            <div id="uploadDataset" class="feature-section"
                style="display: block;"> <!-- Default to Upload Dataset -->
                <h3>Upload Dataset</h3>

                <!-- Inform the user about accepted columns -->
                <p style="color: darkblue; font-weight: bold;">
                    Note: The following columns must be present in the dataset:
                    <ul>
                        <li>Category column (accepted names:
                            <code>category</code>,
                            <code>malware_category</code>, <code>mal_cat</code>,
                            <code>mal_category</code>)</li>
                        <li>Family column (accepted names: <code>family</code>,
                            <code>malware_family</code>, <code>mal_fam</code>,
                            <code>mal_family</code>)</li>
                    </ul>
                </p>

                <!-- Upload form -->
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" name="file" accept=".csv" required>
                    <button type="submit">Upload</button>
                </form>
                <div id="uploadResult"></div>
                <!-- Result area for upload message -->
            </div>

            <!-- Data Visualization Section -->
            <div id="dataVisualization" class="feature-section">
                <h3>Data Visualization</h3>
                <!-- Inform users about the dataset used for visualizations -->
                <p style="color: darkblue; font-weight: bold;">This
                    visualization is based on the last dataset you uploaded.</p>

                <!-- Category Visualization -->
                <div id="categoryVisualization">
                    <h4>Malware Category Distribution</h4>
                    <img id="visualizationCategoryImage" src
                        alt="Malware Category Distribution"
                        style="display: none;">
                    <!-- Image placeholder for categories -->
                    <p id="categoryError" style="display: none; color: red;">No
                        category column found in the dataset.</p>
                </div>

                <!-- Family Visualization -->
                <div id="familyVisualization">
                    <h4>Malware Family Distribution</h4>
                    <img id="visualizationFamilyImage" src
                        alt="Malware Family Distribution"
                        style="display: none;">
                    <!-- Image placeholder for families -->
                    <p id="familyError" style="display: none; color: red;">No
                        family column found in the dataset.</p>
                </div>
            </div>

            <!-- Data Prediction Section -->
<div id="dataPrediction" class="feature-section">
    <h3>Data Prediction</h3>

    <!-- Inform users about the dataset used for predictions -->
    <p style="color: darkblue; font-weight: bold;">Predictions are based on the last 3 datasets you uploaded.</p>

    <div id="predictionResult">
        <h4>Prediction Results:</h4>
        <table id="predictionsTable" style="display: none;">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                </tr>
            </thead>
            <tbody id="predictionsTableBody">
                <!-- Prediction results will be inserted here dynamically -->
            </tbody>
        </table>
    </div>
</div>


            <!-- Manage Users Section -->
            <div id="manageUsersTable" class="feature-section">
                <h3>Manage Users</h3>

                <!-- Add New User Section inside Manage Users -->
                <details>
                    <summary
                        style="cursor: pointer; font-weight: bold; padding: 10px; background-color: #3a3f51; color: white; border-radius: 4px; display: inline-block;">Add
                        User</summary>
                    <div class="add-user-form">
                        <h3>Add New User</h3>
                        <form action="{{ url_for('add_user') }}" method="POST">
                            <label for="username">Username:</label>
                            <input type="text" name="username" id="username"
                                required>

                            <label for="password">Password:</label>
                            <input type="password" name="password" id="password"
                                required>

                            <label for="role">Role:</label>
                            <select name="role" id="role" required>
                                <option value="admin">Admin</option>
                                <option value="user">User</option>
                            </select>

                            <button type="submit">Add User</button>
                        </form>

                    </div>
                </details>

                <table id="manageUsersTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Role</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- JavaScript will insert users here dynamically -->
                    </tbody>
                </table>
            </div>

            <!-- Q&A Section -->
            <div id="qnaSection" class="feature-section">
                <h3>Q&A Section</h3>
                <div id="unansweredQuestions"></div>
            </div>

            <!-- JavaScript -->
            <script>
        // Function to handle logout
        function logout() {
            fetch('/logout', {
                method: 'POST',
            })
            .then(response => {
                if (response.ok) {
                    window.location.href = '/login';  // Redirect to the login page
                } else {
                    alert('Logout failed. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error during logout:', error);
                alert('An error occurred while logging out.');
            });
        }
    
        // Show the default section (Upload Dataset) when the page loads
    function showSection(sectionId) {
    const sections = document.querySelectorAll('.feature-section');
    sections.forEach(section => {
        section.style.display = 'none'; // Hide all sections
    });
    document.getElementById(sectionId).style.display = 'block'; // Show the selected section

    // Load predictions directly when opening the Data Prediction section
    if (sectionId === 'dataPrediction') {
        loadPredictions();
    }

    // Load visualization directly when opening the Data Visualization section
    if (sectionId === 'dataVisualization') {
        loadVisualization();
    }
 // Load questions directly when opening the Q&A section
    if (sectionId === 'qnaSection') {
        loadAllQuestions();
    }
    // Load the manage users dynamically when Manage Users section is opened
    if (sectionId === 'manageUsersTable') {
        loadUsers();
    }
}

function loadUsers() {
    fetch('/manage_users_data')  // Backend route that returns the user data as JSON
    .then(response => response.json())
    .then(data => {
        const tableBody = document.querySelector('#manageUsersTable tbody');
        tableBody.innerHTML = '';  // Clear existing table rows
        data.users.forEach(user => {
            tableBody.innerHTML += `
                <tr id="user_${user._id}">
                    <td>${user.username}</td>
                    <td>
                        <select id="role_${user._id}" name="role">
                            <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                            <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                        </select>
                    </td>
                    <td>
                        <input type="password" id="password_${user._id}" placeholder="New Password (optional)">
                        <button onclick="updateUser('${user._id}')">Update</button>
                        <button onclick="deleteUser('${user._id}')" style="background-color: #d9534f;">Delete</button>
                    </td>
                </tr>
            `;
        });
    })
    .catch(error => console.error('Error fetching user data:', error));
}

    
        document.getElementById('uploadForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Prevent the default form submission
 
    const formData = new FormData(this); // Create a FormData object
 
    fetch('/upload_dataset', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        // Update the upload result area
        document.getElementById('uploadResult').innerHTML = `
            <p style="color: green;">Dataset uploaded successfully! You can now view visualizations and predictions.</p>
        `;
        // Reset the visualization images
        document.getElementById('visualizationCategoryImage').style.display = 'none';
        document.getElementById('visualizationFamilyImage').style.display = 'none';
        document.getElementById('categoryError').style.display = 'none';
        document.getElementById('familyError').style.display = 'none';
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('uploadResult').innerHTML = '<p style="color: red;">An error occurred while uploading the dataset.</p>';
    });
});

        // Load visualization when opening the Data Visualization section
function loadVisualization() {
    fetch('/data_visualization', {
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        // Handle the category visualization
        if (data.category_visualization) {
            document.getElementById('visualizationCategoryImage').src = "data:image/png;base64," + data.category_visualization;
            document.getElementById('visualizationCategoryImage').style.display = 'block'; // Show category image
            document.getElementById('categoryError').style.display = 'none'; // Hide error message
        } else {
            document.getElementById('visualizationCategoryImage').style.display = 'none'; // Hide category image
            document.getElementById('categoryError').style.display = 'block'; // Show error message
        }

        // Handle the family visualization
        if (data.family_visualization) {
            document.getElementById('visualizationFamilyImage').src = "data:image/png;base64," + data.family_visualization;
            document.getElementById('visualizationFamilyImage').style.display = 'block'; // Show family image
            document.getElementById('familyError').style.display = 'none'; // Hide error message
        } else {
            document.getElementById('visualizationFamilyImage').style.display = 'none'; // Hide family image
            document.getElementById('familyError').style.display = 'block'; // Show error message
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while loading the visualization.');
    });
}

    
        // Load predictions directly when opening the Data Prediction section
       // Load predictions directly when opening the Data Prediction section
function loadPredictions() {
    fetch('/admin_prediction', {
        method: 'POST',
    })
    .then(response => response.json())
    .then(data => {
        if (data.summary) {
            // Prepare table rows with predictions
            const tableBody = document.getElementById('predictionsTableBody');
            tableBody.innerHTML = `
                <tr>
                    <td>Most Common Malware Family</td>
                    <td>${data.summary.most_common_family}</td>
                </tr>
                <tr>
                    <td>Least Common Malware Family</td>
                    <td>${data.summary.least_common_family}</td>
                </tr>
                <tr>
                    <td>Most Common Malware Category</td>
                    <td>${data.summary.most_common_category}</td>
                </tr>
                <tr>
                    <td>Least Common Malware Category</td>
                    <td>${data.summary.least_common_category}</td>
                </tr>
            `;
            
            // Display the table
            document.getElementById('predictionsTable').style.display = 'table';
        } else {
            document.getElementById('predictionsTableBody').innerHTML = `
                <tr>
                    <td colspan="2" style="color: red;">${data.error}</td>
                </tr>
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        document.getElementById('predictionsTableBody').innerHTML = `
            <tr>
                <td colspan="2" style="color: red;">An error occurred while making predictions.</td>
            </tr>
        `;
    });
}

    
        // Load all questions in the Q&A section (answered and unanswered)
        function loadAllQuestions() {
    fetch('/view_all_questions', {
        method: 'GET',
    })
    .then(response => response.json())
    .then(data => {
        const unansweredQuestionsDiv = document.getElementById('unansweredQuestions');
        unansweredQuestionsDiv.innerHTML = ''; // Clear previous content

        if (data.all_questions.length > 0) {
            data.all_questions.forEach(question => {
                let questionHTML = `
                    <div>
                        <strong>Q: ${question.question}</strong><br>
                        <strong>Asked by:</strong> ${question.user} <br>
                        <strong>Asked on:</strong> ${new Date(question.timestamp).toLocaleString()}<br>
                `;

                if (question.status === 'unanswered') {
                    // If question is unanswered, show the answer input
                    questionHTML += `
                        <textarea id="answer_${question._id}" placeholder="Write your answer"></textarea>
                        <button onclick="submitAnswer('${question._id}')">Submit Answer</button>
                    `;
                } else {
                    // If question is answered, show the answer
                    questionHTML += `
                        <strong>A: ${question.answer}</strong><br>
                        <strong>Answered by:</strong> ${question.admin} <br>
                        <strong>Answered on:</strong> ${new Date(question.answered_timestamp).toLocaleString()}
                    `;
                }

                questionHTML += '</div><hr>';
                unansweredQuestionsDiv.innerHTML += questionHTML;
            });
        } else {
            unansweredQuestionsDiv.innerHTML = '<p>No questions available.</p>';
        }
    })
    .catch(error => {
        console.error('Error fetching questions:', error);
        document.getElementById('unansweredQuestions').innerHTML = '<p style="color: red;">An error occurred while loading questions.</p>';
    });
}


// Submit answer to a question
function submitAnswer(questionId) {
    const answer = document.getElementById(`answer_${questionId}`).value;

    if (!answer) {
        alert('Answer cannot be empty!');
        return;
    }

    fetch(`/submit_answer/${questionId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ answer: answer })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        loadAllQuestions();  // Reload all questions after submitting an answer
    })
    .catch(error => {
        console.error('Error submitting answer:', error);
        alert('An error occurred while submitting the answer.');
    });
}

function updateUser(userId) {
    const role = document.querySelector(`#role_${userId}`).value;
    const newPassword = document.querySelector(`#password_${userId}`).value;

    fetch(`/update_user/${userId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            role: role,
            new_password: newPassword
        }),
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        // Optionally, refresh the user list or show updated user info
    })
    .catch(error => {
        console.error('Error updating user:', error);
    });
}

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        fetch(`/delete_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            // Remove the user from the table
            document.querySelector(`#user_${userId}`).remove();
        })
        .catch(error => {
            console.error('Error deleting user:', error);
        });
    }
}



        function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        fetch(`/delete_user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            alert(data.message);
            // Optionally, remove the user from the table
            document.querySelector(`#user_${userId}`).remove();
        })
        .catch(error => {
            console.error('Error deleting user:', error);
        });
    }
}


        // Submit answer to a question
        function submitAnswer(questionId) {
            const answer = document.getElementById(`answer_${questionId}`).value;
    
            if (!answer) {
                alert('Answer cannot be empty!');
                return;
            }
    
            fetch(`/submit_answer/${questionId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ answer: answer })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                loadAllQuestions();  // Reload all questions after submitting an answer
            })
            .catch(error => {
                console.error('Error submitting answer:', error);
                alert('An error occurred while submitting the answer.');
            });
        }
    </script>

        </body>
    </html>
